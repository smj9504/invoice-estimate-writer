<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Estimate</title>
  <link rel="stylesheet" href="insurance_estimate_style.css">
</head>
<body>

<div class="header-top">
  <div class="invoice-meta">
    <h1>Estimate</h1>
    <p><strong>Estimate number</strong> {{ estimate_number or 'N/A' }}</p>
    <p>Estimate Date: {{ estimate_date or 'N/A' }}</p>
  </div>

  <div class="company-logo">
    {% if company and company.logo %}
    <img src="{{ company.logo }}" alt="" class="logo">
    {% endif %}
  </div>
</div>

<div class="address-section">
  <div class="company-info">
    {% if company %}
    <p><strong>{{ company.name or 'Company Name' }}</strong></p>
    {% if company.address %}<p>{{ company.address }}</p>{% endif %}
    {% if company.city or company.state or company.zip %}
    <p>{{ company.city or '' }}{% if company.city and (company.state or company.zip) %}, {% endif %}{{ company.state or '' }} {{ company.zip or '' }}</p>
    {% endif %}
    {% if company.phone %}<p>{{ company.phone }}</p>{% endif %}
    {% if company.email %}<p>{{ company.email }}</p>{% endif %}
    {% else %}
    <p><strong>Company Name</strong></p>
    <p>Company Address</p>
    <p>City, State ZIP</p>
    <p>Phone Number</p>
    <p>Email Address</p>
    {% endif %}
  </div>
  <div class="client-info">
    <p><strong>Estimate for</strong></p>
    {% if client %}
      {% if client.name %}
        <p>{{ client.name }}</p>
      {% endif %}
      {% if client.address %}<p>{{ client.address }}</p>{% endif %}
      {% if client.city or client.state or client.zip %}
      <p>{{ client.city or '' }}{% if client.city and (client.state or client.zip) %}, {% endif %}{{ client.state or '' }} {{ client.zip or '' }}</p>
      {% endif %}
      {% if client.phone %}
        <p>{{ client.phone }}</p>
      {% endif %}
      {% if client.email %}
        <p>{{ client.email }}</p>
      {% endif %}
    {% else %}
      <p>Client Name</p>
      <p>Client Address</p>
      <p>City, State ZIP</p>
    {% endif %}
  </div>
</div>

{% if top_note and top_note != '' %}
  <p class="amount-due-note">{{ top_note|replace('\n', '<br>') | safe }}</p>
{% endif %}

<div class="line-header">
  <div class="col-item">Item</div>
  <div class="col-qty">Qty</div>
  <div class="col-unit">Unit</div>
  <div class="col-price">Unit Price</div>
  <div class="col-desc">Description</div>
</div>

{% set global_item_counter = namespace(value=0) %}

{% if trades %}
  {% for trade in trades %}
    <div class="trade-title">{{ trade.name or 'Trade' }}</div>
    
    {% if trade.note and trade.note != '' %}
      <div class="trade-note">{{ trade.note|replace('\n', '<br>') | safe }}</div>
    {% endif %}
    
    {% if trade.locations %}
      {% for location in trade.locations %}
        {% if location.name %}
          <div class="location-title">{{ location.name }}</div>
        {% endif %}
        
        {% if location.note and location.note != '' %}
          <div class="location-note">{{ location.note|replace('\n', '<br>') | safe }}</div>
        {% endif %}
        
        {% if location.categories %}
          {% for category in location.categories %}
            {% if category.name %}
              <div class="category-title">{{ category.name }}</div>
            {% endif %}
            
            {% if category.items and category.items is iterable and category.items is not string %}
            {% for item in category.items %}
                {% if item and item is mapping and item.name and item.name != '' %}
                {% set global_item_counter.value = global_item_counter.value + 1 %}
                <div class="line-row">
                    <div class="col-item">{{ global_item_counter.value }}. {{ item.name }}</div>
                    <div class="col-qty">
                    {% if item.qty is defined and item.qty != '' and item.qty != none %}
                        {{ "{:,.2f}".format(item.qty | float) }}
                    {% else %}
                        0.00
                    {% endif %}
                    </div>
                    <div class="col-unit">{{ item.unit or '' }}</div>
                    <div class="col-price">
                    {% if item.price is defined and item.price != '' and item.price != none %}
                        ${{ "{:,.2f}".format(item.price | float) }}
                    {% else %}
                        $0.00
                    {% endif %}
                    </div>
                    <div class="col-desc">
                    {% if item.description and item.description != '' %}
                        {{ item.description|replace('\n', '<br>') | safe }}
                    {% endif %}
                    </div>
                </div>
                {% endif %}
            {% endfor %}
            {% else %}

            <div class="line-row" style="color: #999; font-style: italic;">
                <div class="col-item" style="grid-column: 1 / -1;">
                No valid items in category "{{ category.name or 'Unnamed' }}"
                </div>
            </div>
            {% endif %}

          {% endfor %}
        {% endif %}
        
        {% if location.showSubtotal and location.subtotal is defined %}
          <p class="subtotal">{{ location.name or 'Location' }} Subtotal: ${{ "{:,.2f}".format(location.subtotal | float) }}</p>
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endfor %}
{% else %}
  <div class="line-row">
    <div class="col-item" style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #999;">
      No items found in this estimate
    </div>
  </div>
{% endif %}

<div class="footer-total">
  <p>Subtotal: ${{ "{:,.2f}".format(subtotal | float) if subtotal is defined and subtotal != '' else '0.00' }}</p>
  {% if discount is defined and discount != '' and (discount | float) > 0 %}
    <p>Discount: -${{ "{:,.2f}".format(discount | float) }}</p>
  {% endif %}
  {% if sales_tax is defined and sales_tax != '' and (sales_tax | float) > 0 %}
    <p>{{ (client.state if client else '') or '' }} Sales Tax ({{ tax_rate | float if tax_rate is defined else 0 }}%): ${{ "{:,.2f}".format(sales_tax | float) }}</p>
  {% endif %}
  <p class="total">Estimate Total: ${{ "{:,.2f}".format(total | float) if total is defined and total != '' else '0.00' }}</p>
</div>

{% if bottom_note and bottom_note != '' %}
  <p class="note">{{ bottom_note|replace('\n', '<br>') | safe }}</p>
{% endif %}

{% if disclaimer and disclaimer != '' %}
  <p class="disclaimer">{{ disclaimer|replace('\n', '<br>') | safe }}</p>
{% endif %}

</body>
</html>